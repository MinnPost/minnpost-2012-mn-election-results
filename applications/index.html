<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MinnPost</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>
<script type='text/javascript' src='//s7.addthis.com/js/250/addthis_widget.js#async=1'></script>
<link rel="shortcut icon" href="http://www.minnpost.com//sites/default/themes/siteskin/favicon.ico" type="image/x-icon" />
<meta name="keywords" content="Mark Dayton,Minnesota DFL,Minnesota GOP,Minnesota Legislature,Vikings Stadium,Voter ID Amendment" />
<meta name="description" content="  " />
<meta property="og:title" content="The 2012 Legislative session: What did they pass?"/>
<meta property="og:site_name" content="MinnPost"/>
<meta property="og:description" content="Explore bills by category, investigate which bills Gov. Dayton vetoed, and search by your legislators.
"/>
<meta property="og:image" content="http://www.minnpost.com/sites/default/files/images/thumbnails/fullpagearticles/BillExplorerGraphic3.png"/>
<link rel="apple-touch-icon" href="http://www.minnpost.com//sites/default/themes/siteskin/inc/images/apple-touch-icon.png" />
<meta name="viewport" content="width=device-width, initial-scale=1"></meta>


  <link type="text/css" rel="stylesheet" media="all" href="http://www.minnpost.com/sites/default/files/css/css_821e22b02514b6df405432d971d85dea.css" />
<link type="text/css" rel="stylesheet" media="screen" href="http://www.minnpost.com/sites/default/files/css/css_b26ad2d81bc74f1246e9c9a4c45ecdea.css" />
<link type="text/css" rel="stylesheet" media="print" href="http://www.minnpost.com/sites/default/files/css/css_cd72d16d00ebb27825710d934e28fbe8.css" />
  <!--[if IE]>
      <link rel="stylesheet" href="http://www.minnpost.com/sites/default/themes/derma/inc/css/ie.css?n" type="text/css">
  <![endif]-->
    <script type="text/javascript" src="http://www.minnpost.com/sites/default/files/js/js_de97366bf2ae2bb44590e7cf73e2a6d6.js"></script>
<script type="text/javascript" src="http://www.minnpost.com/sites/all/libraries/tinymce/jscripts/tiny_mce/tiny_mce.js?n"></script>
    

</head>
<body class="not-front logged-in page-node node-type-article one-sidebar sidebar-right admin-nw admin-vertical admin-df  section-data section-data-id-2012 section-data-id-2012-id-05 section-data-id-2012-id-05-how-we-built-legislative-bill-explorer one-sidebar sidebar-right">
<div class="outside-embeddable-container">




  <!-- START: Embeddable -->
  <div class="node-body fieldlayout node-field-body">
    <style type="text/css">
      @import url('https://s3.amazonaws.com/data.minnpost/js/qtip2-master-20121022/jquery.qtip.min.css');
    </style>
    
    <style type="text/css">
      #minnpost-2012-mn-election-results {
        max-width: 960px;
        margin: 0 auto;
      }
      .clear {
        clear: both;
      }
      .js-dependent,
      .hidden {
        display: none;
      }
      .footnote {
        font-size: .75em;
        font-style: italic;
        color: #414141;
        margin-top: 1em;
      }
      #minnpost-2012-mn-election-results table {
        width: 100%;
      }
      #minnpost-2012-mn-election-results .inner-container {
        padding: 0 .5em;
      }
      
      .loading-general {
        width: 100%;
        text-align: center;
        padding: 1em 2em;
        color: #ABABAB;
        vertical-align: middle;
      }
      .loading-general span {
        padding: 10px 5px 10px 40px;
        background: transparent url('images/ajax-loader.gif') center left no-repeat;
        vertical-align: middle;
      }
      
      .race-permalink {
        font-size: .5em;
      }
      
      .race-status {
        color: #ABABAB;
      }
      
      /**
       * Dashboard
       */
      .dashboard-header-container {
        text-align: center;
        margin-bottom: 2em;
      }
      .dashboard-president-container,
      .dashboard-amendments-container {
        width: 50%;
        float: left;
        margin-bottom: 1em;
      }
      .dashboard-amendments-amendment {
        width: 50%;
        float: left;
      }
      .barchart-container {
        margin-bottom: 1em;
      }
      .barchart-container div {
        height: 2em;
        float: left;
      }
      
      .donut-chart-container {
        height: 200px;
        width: 100%;
      }
    </style>
    
    
    
    <!-- Initial HTML for application -->
    <div id="minnpost-2012-mn-election-results">
      <noscript>
        <p>This application requires Javascript which is used to make your web browser more interactive.  If this message does not go away, please consider enabling Javascript.  Here are <a href="http://www.enable-javascript.com/" target="_blank">instructions on how to enable JavaScript in your web browser</a>.</p>
      </noscript>
      
      <div id="render-container">
      </div>
      
      <p class="footnote">Election data provided by the <a href="http://www.sos.state.mn.us/" target="_blank">MN Secretary of State</a>.</p>
    </div>
    
    <!-- Templates to be used in client side processing. -->
    <script id="template-race-view" type="text/template">
      <% if (typeof race == 'undefined') { %>
        <p>No race or contest found.</p>
      <% } else { %>
        <% if (typeof races == 'undefined') { %>
          <h3><%= race %> <a class="race-permalink" href="#race/<%= race_id %>" title="Permanent link to this race">permalink</a></h3>
        <% } else { %>
          <h4><%= race %> <a class="race-permalink" href="#race/<%= race_id %>" title="Permanent link to this race">permalink</a></h4>
        <% } %>
        
        <% if (typeof question_body != 'undefined' && question_body != '') { %>
          <p><%= question_body %></p>
        <% } %>
        
        <p class="race-status">
        <% if (typeof races == 'undefined') { %>
          Last updated at <strong><%= updated_moment.format('MMM Do h:mm A') %></strong> with
          <strong><%= (precincts_percentage * 100).toFixed(2) %>%</strong> 
            (<%= _.formatNumber(precincts_reporting) %> 
            of <%= _.formatNumber(total_effected_precincts) %>) precincts reporting.
        <% } else { %>
          <strong><%= (precincts_percentage * 100).toFixed(2) %>%</strong> 
            (<%= _.formatNumber(precincts_reporting) %> 
            of <%= _.formatNumber(total_effected_precincts) %>) precincts reporting.
        <% } %>
        </p>
        
        <table>
          <thead>
            <tr><th>Candidate</th><th>Party</th><th>Votes</th><th>Percentage</th></tr>
          </thead>
          <tbody>
            <% candidates = _.sortBy(candidates, function(c) {  return c.percentage * -1; }); %>
            <% for (var c in candidates) { %>
              <% if (candidates[c].candidate !== 'WRITE-IN**' || candidates[c].percentage > 10) { %>
                <tr>
                  <th><%= candidates[c].candidate %></th>
                  <th><%= candidates[c].partyOutput %></th>
                  <th><%= _.formatNumber(candidates[c].votes_candidate) %></th>
                  <th><%= candidates[c].percentage %></th>
                </tr>
              <% } %>
            <% } %>
          </tbody>
        </table>
      <% } %>
    </script>
    
    <script id="template-service-down" type="text/template">
      <h3>We are sorry</h3>
      <p>The election data service seems to be down.</p>
    </script>
    
    <script id="template-races-view" type="text/template">
      <h3><%= title %></h3>
      <p class="race-status">Last updated at <%= updated_moment.format('MMM Do h:mm A') %>.</p>
      
      <div class="races-races-list">
        <% if (typeof racesRendered == 'undefined' || races === '') { %>
          <p>No races or contests found.</p>
        <% } else { %>
          <%= racesRendered %>
        <% } %>
      </div>
    </script>
    
    <script id="template-dashboard-view" type="text/template">
      <div class="dashboard-header"></div>
      
      <div class="dashboard-summaries"></div>
    </script>
    
    <script id="template-dashboard-header" type="text/template">
      <div class="dashboard-header-container">
        <p>
          <% if (typeof updated != 'undefined') { %>
            Last updated at <strong><%= moment.unix(updated.value_blob).format('MMM Do h:mm A') %></strong> with
            <strong><%= (precincts_reporting.value_blob * 100 / total_effected_precincts.value_blob).toFixed(2) %>%</strong> 
              (<%= _.formatNumber(precincts_reporting.value_blob) %> 
              of <%= _.formatNumber(total_effected_precincts.value_blob) %>) precincts reporting;
            tracking <strong><%= _.formatNumber(races.value_blob) %></strong> races.
          <% } %>  
        </p>
      </div>
    </script>
    
    <script id="template-party-value" type="text/template">
      <span class="party" style="color: <%= party.colors[0] %>" title="<%= party.title %>"><%= value %></span>
    </script>
    
    <script id="template-loading" type="text/template">
      <div class="loading-general"><span>Loading...</span></div>
    </script>
    
    <script id="template-dashboard-president" type="text/template">
      <div class="dashboard-president-container">
        <div class="inner-container">
          <h4>Presidential <a class="race-permalink"  title="Permanent link to this race" href="#race/<%= race_id %>">permalink</a></h4>
          <p class="race-status"><%= (precincts_percentage * 100).toFixed(2) %>% (<%= _.formatNumber(precincts_reporting) %> of <%= _.formatNumber(total_effected_precincts) %>) precincts reporting. <br />
            Minnesota results only.</p>
            
          <table>
            <tbody>
              <% candidates = _.sortBy(candidates, function(c) {  return c.percentage * -1; }); %>
              <% for (var c in candidates) { %>
                <% if (_.contains(['R', 'DFL'], candidates[c].party_id)) { %>
                  <tr>
                    <th><%= candidates[c].candidate %></th>
                    <th><%= candidates[c].partyOutput %></th>
                    <th><%= candidates[c].percentage %>%</th>
                  </tr>
                <% } %>
              <% } %>
            </tbody>
          </table>
          
          <div class="dashboard-president-chart"></div>
        </div>
      </div>
    </script>
    
    <script id="template-dashboard-amendments" type="text/template">
      <div class="dashboard-amendments-container">
        <div class="inner-container">
          <h4>Amendments <a class="race-permalink"  title="Permanent link to this race" href="#races/office_name/amendment">permalink</a></h4>
          <p class="race-status"><%= (precincts_percentage * 100).toFixed(2) %>% (<%= _.formatNumber(precincts_reporting) %> of <%= _.formatNumber(total_effected_precincts) %>) precincts reporting.</p>
          
          <div class="dashboard-amendments-amendment">
            <h5>Marriage Amendment</h5>
            <div id="amendment-1-canvas" class="donut-chart-container"></div>
          </div>
          <div class="dashboard-amendments-amendment">
            <h5>Voter ID Amendment</h5>
            <div id="amendment-2-canvas" class="donut-chart-container"></div>
          </div>
        </div>
      </div>
    </script>
    
    <script id="template-dashboard-state-leg" type="text/template">
      <h4>State legislature</h4>
      <p>Some stuff.</p>
    </script>
    
    <script id="template-dashboard-congress" type="text/template">
      <h4>Congress</h4>
      <p>Some stuff.</p>
    </script>
    
    <script id="template-barchart-view" type="text/template">
      <div class="barchart-container clear-block">
        <% for (var i in c) { %>
          <div class="race-<%= c[i].race_id %> cand-<%= c[i].candidate_id %>"
            style="width: <%= c[i].width * 100 %>%; background-color: <%= c[i].color %>;"></div>
        <% } %>
      </div>
    </script>
    
    <script id="template-tooltip-candidate" type="text/template">
      <div class="tooltip-candidate-container">
        <h5><%= c.candidate %></h5>
        <div>Percent of votes: <%= c.percentage %>%</div>
        <div>Number of votes: <%= _.formatNumber(c.votes_candidate) %></div>
      </div>
    </script>
  
  
  
    <!-- jQuery that is used on site -->
    <script type="text/javascript">
      window.jQuery || document.write('<script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/jquery-1.3.2/jquery-1.3.2.min.js"><\/script>')
    </script>
    <!-- Underscore, a custom jquery, and backbone for app logic -->
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/underscore-1.3.3/underscore-min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/jquery-custom-master-20120606/jquery-1.7.2.custom.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/jquery.jsonp-2.4.0/jquerycustom.jsonp-2.4.0.min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/backbone-0.9.2/backbone-min.js"></script>
    <!-- Date handling -->
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/moment.js-1.7.2/moment.min.js"></script>
    <!-- Drawing and Tooltips -->
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/raphael-2.1.0/raphael-min.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/qtip2-master-20121022/jquerycustom.qtip.min.js"></script>
    
    <script type="text/javascript">
      // Add some helpful funcitons to Backboe, because that makes
      // sense.
      _.formatNumber = function(num) {
        num = _.isUndefined(num) ? 0 : num;
        var array = num.toString().split('');
        var index = -3;
        while (array.length + index > 0) {
        array.splice(index, 0, ',');
          // Decrement by 4 since we just added another unit to the array.
          index -= 4;
        }
        return array.join('');
      };
    
      // Handle custom jQuery
      jQueryCustom = jQueryCustom.noConflict();
      Backbone.setDomLibrary(jQueryCustom);
      
      // Donut chart for Raphael (see http://jsfiddle.net/amadanNM/VdTH4/2/)
      Raphael.fn.donutChart = function(cx, cy, r, rin, rout, values, colors, divider, stroke) {
        var paper = this;
        var rad = Math.PI / 180;
        var chart = this.set();
        var angle = 0, total = 0, start = 0;
        divider = (_.isNumber(divider)) ? divider : 1;
                
        var sector = function(cx, cy, r, r2, startAngle, endAngle, params) {
          var x1 = cx + r * Math.cos(-startAngle * rad),
            x2 = cx + r * Math.cos(-endAngle * rad),
            y1 = cy + r * Math.sin(-startAngle * rad),
            y2 = cy + r * Math.sin(-endAngle * rad),
            xx1 = cx + r2 * Math.cos(-startAngle * rad),
            xx2 = cx + r2 * Math.cos(-endAngle * rad),
            yy1 = cy + r2 * Math.sin(-startAngle * rad),
            yy2 = cy + r2 * Math.sin(-endAngle * rad);
          
          return paper.path(['M', xx1, yy1,
            'L', x1, y1, 
            'A', r, r, 0, +(endAngle - startAngle > 180), 0, x2, y2, 
            'L', xx2, yy2, 
            'A', rin, rin, 0, +(endAngle - startAngle > 180), 1, xx1, yy1, 'z']
          ).attr(params);
        };
        var processSector = function(j) {
          var value = values[j];
          var angleplus = 360 * value / total / divider;
          var popangle = angle + (angleplus / 2);
          var ms = 500, delta = 30;
          var attr = { fill: colors[j], 'stroke-width': 0 };
          if (stroke) {
            attr.stroke = stroke;
            attr['stroke-width'] = 1;
          }
          var p = sector(cx, cy, r, rin,angle, angle + angleplus, attr);
          
          angle += angleplus;
          chart.push(p);
          start += .1;
        };
        
        // Get total
        _.each(values, function(v) {
          total += v;
        });
        // Process each sector
        _.each(values, function(v, i) {
          processSector(i);
        });
        return chart;
      };
      
      // Make the magic happen
      (function($, w, undefined) {
        // API URL for easy switching
        var baseAPIURL = 'http://ec2-174-129-137-145.compute-1.amazonaws.com/?box=ubuntu&callback=?&q='
        //var baseAPIURL = 'http://box.scraperwiki.com/zzolo/mn-2012-election-results/sqlite?callback=?&q='
      
        // Model for a single race
        var Race = Backbone.Model.extend({
          url: function() {
            return baseAPIURL + encodeURI("SELECT * FROM results_general WHERE race_id = '" + 
              this.get('race_id') + "' LIMIT 100");
          },
          
          initialize: function() {
            this.partyViewer = this.partyViewer || new PartyView();
          },
          
          parse: function(response) {
            var parsed = {};
            this.partyViewer = this.partyViewer || new PartyView();
            
            parsed.candidates = response;
            parsed.candidates = _.map(response, function(r) {
              r.partyOutput = this.partyViewer.render(r.party_id, r.party_id);
              return r;
            }, this);
            
            if (!_.isUndefined(response[0])) {
              parsed.race_id = response[0].race_id;
              parsed.race = response[0].office_name;
              parsed.updated = response[0].updated;
              parsed.updated_moment = moment.unix(response[0].updated);
              parsed.precincts_reporting = response[0].precincts_reporting;
              parsed.total_effected_precincts = response[0].total_effected_precincts;
              parsed.precincts_percentage = parsed.precincts_reporting / parsed.total_effected_precincts;
              parsed.question_body = response[0].question_body;
            }
            return parsed;
          }
        });
        
        // Collection for races
        var Races = Backbone.Collection.extend({
          url: function() {
            var query = [];
            this.options.limit = this.options.limit || 100;
            
            // Put together query
            query.push("SELECT * FROM results_general WHERE ");
            query.push(this.options.field + " ");
            query.push(_.isArray(this.options.search) ?
              "IN ('" + this.options.search.join("', '") + "') "
              : "LIKE '%" + this.options.search + "%' ");
            query.push("ORDER BY office_name ");
            query.push("LIMIT " + this.options.limit + " ");
            
            return baseAPIURL + encodeURI(query.join(''));
          },
          
          model: Race,
          
          parse: function(response) {
            return _.values(_.groupBy(response, 'race_id'));
          },
          
          initialize: function(models, options) {
            this.options = options || {};
          },
          
          exportData: function() {
            var data = {};
            data.races = this.toJSON();

            // Determine title
            data.title = this.options.search;
            
            // Get first race to get some aggregate values
            data.updated = this.at(0).get('updated');
            data.updated_moment = this.at(0).get('updated_moment');
            data.precincts_percentage = this.at(0).get('precincts_percentage');
            data.precincts_reporting = this.at(0).get('precincts_reporting');
            data.total_effected_precincts = this.at(0).get('total_effected_precincts');
            
            return data;
          }
        });
        
        // View for a single race
        var RaceView = Backbone.View.extend({
          initialize: function() {
            this.template = $('#template-race-view').html();
            this.loadingTemplate = $('#template-loading').html();
          }, 
          
          render: function() {
            $(this.el).html(_.template(this.template, this.model.toJSON()));
            return this;
          },
          
          loading: function() {
            $(this.el).html(_.template(this.loadingTemplate, {}));
            return this;
          }
        });
        
        // View for a multiple races
        var RacesView = Backbone.View.extend({
          initialize: function() {
            this.template = $('#template-races-view').html();
            this.raceTemplate = $('#template-race-view').html();
            this.loadingTemplate = $('#template-loading').html();
          }, 
          
          render: function() {
            var data = this.collection.exportData();
            data.racesRendered = [];
            
            // Render each race
            this.collection.each(function(r) {
              var rData = r.toJSON();
              rData.races = true;
              data.racesRendered.push(_.template(this.raceTemplate, rData));
            }, this);
            data.racesRendered = data.racesRendered.join(' ');
            
            $(this.el).html(_.template(this.template, data));
            return this;
          },
          
          loading: function() {
            $(this.el).html(_.template(this.loadingTemplate, {}));
            return this;
          }
        });
        
        // View for dashbard
        var DashboardView = Backbone.View.extend({
          metadataURL: baseAPIURL + encodeURI("SELECT * FROM swvariables"),
          
          initialize: function() {
            this.partyView = new PartyView();
            this.template = $('#template-dashboard-view').html();
            this.loadingTemplate = $('#template-loading').html();
            this.headerTemplate = $('#template-dashboard-header').html();
            this.serviceDownTemplate = $('#template-service-down').html();
            
            this.summaries = {
              president: {
                collection: new Races([], {
                  field: 'race_id',
                  search: 'id----0101'
                }),
                className: 'dashboard-president',
                render: function() {
                  var race = this.collection.at(0);
                  var data = race.toJSON();
                  
                  // Render template and chart
                  $('.' + this.className).html(
                    _.template($('#template-' + this.className).html(), data));
                    
                  // Create barchart
                  var chart = new RaceBarChart({
                    el: '.' + this.className + '-chart',
                    model: race
                  });
                  chart.render();
                }
              },
              amendments: {
                collection: new Races([], {
                  field: 'office_name',
                  search: 'amendment'
                }),
                className: 'dashboard-amendments',
                render: function() {
                  $('.' + this.className).html(_.template($('#template-' + this.className).html(), this.collection.exportData()));
                  
                  // Create donut chart
                  var chart1 = new RaceDonutChart({
                    el: '#amendment-1-canvas',
                    model: this.collection.at(0)
                  }).render();
                  var chart2 = new RaceDonutChart({
                    el: '#amendment-2-canvas',
                    model: this.collection.at(1)
                  }).render();
                }
              },
              stateLeg: {
                collection: new Races([], {
                  field: 'office_name',
                  search: 'amendment'
                }),
                className: 'dashboard-state-leg',
                render: function() {
                  $('.' + this.className).html(_.template($('#template-' + this.className).html(), {}));
                }
              },
              congress: {
                collection: new Races([], {
                  field: 'office_name',
                  search: 'amendment'
                }),
                className: 'dashboard-congress',
                render: function() {
                  $('.' + this.className).html(_.template($('#template-' + this.className).html(), {}));
                }
              }
            };
          },
        
          render: function() {
            this.$el = this.$el || $(this.el);
            this.$el.html(_.template(this.template, {}));
            
            // Get metadata for races.  This will also be the global-ish
            // mechanism to note if the service is down.
            var thisView = this;
            this.loading('.dashboard-header');
            $.jsonp({
              url: this.metadataURL,
              success: function(data) {
                thisView.metadata = {};
                _.each(data, function(d) { thisView.metadata[d.name] = d; });
                $('.dashboard-header').html(_.template(thisView.headerTemplate, thisView.metadata));
              },
              error: function(e) {
                $('#render-container').html(_.template(thisView.serviceDownTemplate, {}));
              }
            });
            
            // Add sumary containers and start rendering
            this.$summaries = this.$el.find('.dashboard-summaries');
            _.each(this.summaries, function(summary, s) {
              $('<div>').addClass(summary.className).appendTo(this.$summaries);
              
              this.loading('.' + summary.className);
              summary.collection.fetch({
                success: function(collection, response) {
                  summary.render();
                }
              });
            }, this);
          },
          
          loading: function(el) {
            el = el || this.el;
            $(el).html(_.template(this.loadingTemplate, {}));
            return this;
          }
        });
        
        // View for a race in barchart form
        var RaceBarChart = Backbone.View.extend({
          initialize: function() {
            this.template = $('#template-barchart-view').html();
            this.tooltipTemplate = $('#template-tooltip-candidate').html();
            this.partyView = new PartyView();
          },
          
          render: function() {
            var cands = this.model.get('candidates');
            var pp = this.model.get('precincts_percentage');
            var up = 1 - this.model.get('precincts_percentage');
            var offsetX = 0, min = .1, max = .9;
            
            // Reign in precincts reporting a bit so that the visualization
            // is not too skewed (except when 100% reporting).
            pp = (pp < min) ? min : ((pp > max && pp < 1) ? max : pp);
            // Sort and create offsets
            cands = _.sortBy(cands, function(c) { return c.percentage * -1; });
            cands = _.map(cands, function(c) {
              c.width = pp * c.percentage / 100;
              c.offsetX = offsetX;
              offsetX += c.width;
              c.color = this.partyView.getColor(c.party_id);
              return c;
            }, this);
            // Add a point of data that represents the precints
            // not reporting
            cands.push({
              width: (1 - pp),
              offsetX: offsetX,
              color: this.partyView.getColor(),
              candidate: 'There are an unknown number of voters in ' + (up * 100).toFixed(2) + '% of precincts that have not reported yet',
              percentage: (up * 100).toFixed(2),
              votes_candidate: 0
            });
            $(this.el).html(_.template(this.template, { c: cands, pp: pp }));
            
            // Add tooltips
            _.each(cands, function(c) {
              $('.race-' + c.race_id + '.cand-' + c.candidate_id).qtip({
                content: {
                  text: _.template(this.tooltipTemplate, { c: c })
                },
                style: {
                  classes: 'ui-tooltip-shadow ui-tooltip-light'
                },
                position: {
                  at: 'top center',
                  my: 'bottom center'
                }
              });
            }, this);
            return this;
          }
        });
        
        // View for race in donut chart form
        var RaceDonutChart = Backbone.View.extend({
          initialize: function() {
            this.template = $('#template-donut-view').html();
            this.tooltipTemplate = $('#template-tooltip-candidate').html();
            this.partyView = new PartyView();
          },
          
          render: function() {
            var cands = this.model.get('candidates');
            var pp = this.model.get('precincts_percentage');
            var up = 1 - this.model.get('precincts_percentage');
            var offsetX = 0, min = .1, max = .9;
            
            // Reign in precincts reporting a bit so that the visualization
            // is not too skewed (except when 100% reporting).
            pp = (pp < min) ? min : ((pp > max && pp < 1) ? max : pp);
            // Sort and create offsets
            cands = _.sortBy(cands, function(c) { return c.percentage * -1; });
            cands = _.map(cands, function(c) {
              c.rPercentage = pp * c.percentage / 100;
              c.color = this.partyView.getColor(c.party_id);
              return c;
            }, this);
            // Add a point of data that represents the precints
            // not reporting
            cands.push({
              color: this.partyView.getColor(),
              candidate: 'There are an unknown number of voters in ' + (up * 100).toFixed(2) + '% of precincts that have not reported yet',
              rPercentage: up,
              votes_candidate: 0
            });
            
            // Render donut chart
            var values = _.pluck(cands, 'rPercentage');
            var colors = _.pluck(cands, 'color');
            var w = $(this.el).width();
            var h = $(this.el).height();
            var d = (w >= h) ? h : w;
            var chart = Raphael($(this.el).attr('id'), w, h)
              .donutChart(d / 2, d / 2, d / 2, d * .25, d * .95, values, colors, 1.5, '#fff');
            
            // Add tooltips
            _.each(chart, function(n, i) {
              $(n.node).qtip({
                content: {
                  text: _.template(this.tooltipTemplate, { c: cands[i] })
                },
                style: {
                  classes: 'ui-tooltip-shadow ui-tooltip-light'
                },
                position: {
                  at: 'top center',
                  my: 'bottom center'
                }
              });
            }, this);
            return this;
          }
        });
        
        // View for parties
        var PartyView = Backbone.View.extend({
          partyColors: {
            'IP': { colors: [ 'orange' ], title: 'Independence' },
            'R': { colors: [ 'red' ], title: 'Republican' },
            'DFL': { colors: [ 'blue' ], title: 'Democratic-Farmer-Labor' },
            'LIB': { colors: [ 'aqua' ], title: 'Libertarian Party' },
            'SWP': { colors: [ 'navy' ], title: 'Socialist Workers Party' },
            'CP': { colors: [ 'maroon' ], title: 'Constitution Party' },
            'CG': { colors: [ 'yellow' ], title: 'Constitutional Government' },
            'GP': { colors: [ 'green' ], title: 'Green Party' },
            'GR': { colors: [ 'lime' ], title: 'Grassroots Party' },
            'MOP': { colors: [ 'olive' ], title: 'Minnesota Open Progressives' },
            'EDP': { colors: [ 'purple' ], title: 'Ecology Democracy Party' },
            'IND': { colors: [ 'silver' ], title: 'Independent' },
            'SL': { colors: [ 'teal' ], title: 'Socialism and Liberation' },
            'JP': { colors: [ 'lightblue' ], title: 'Justice Party' },
            'NP': { colors: [ '#DCDCDC' ], title: 'Nonpartisan' },
            'WI': { colors: [ '#999999' ], title: 'Write-In' },
            'NONE': { colors: [ '#FAFAFA' ], title: 'No party assigned' }
          },
          
          initialize: function() {
            this.template = $('#template-party-value').html();
          },
          
          getColor: function(party) {
            return (!_.isUndefined(this.partyColors[party]) && 
              this.partyColors[party].colors[0] !== '') ?
              this.partyColors[party].colors[0] : this.partyColors.NONE.colors[0];
          },
          
          render: function(party, value) {
            return _.template(this.template, {
              value: value,
              party: (_.isUndefined(this.partyColors[party])) ? { } : this.partyColors[party],
              partyID: party
            });
          }
        });
        
        // Main router and workspace for actions
        var Workspace = Backbone.Router.extend({
          routes: {
            'dashboard': 'showDashboard',
            'search/:term': 'search',
            'race/:race': 'showRace',
            'races/*races': 'showRaceGroup',
            '*default': 'defaultRoute'
          },
        
          initialize: function() {
            // Models, collections
            this.race = new Race();
            this.race.on('change', function(e) {
              this.raceView.render();
            }, this);
            this.races = new Races();
            this.races.on('reset', function(e) {
              this.racesView.render();
            }, this);
            
            // Views
            this.raceView = new RaceView({
              model: this.race,
              el: '#render-container'
            });
            this.racesView = new RacesView({
              collection: this.races,
              el: '#render-container'
            });
            this.dashboardView = new DashboardView({
              el: '#render-container'
            });
          },
        
          defaultRoute: function() {
            this.navigate('/dashboard', { trigger: true, replace: true });
          },
        
          showDashboard: function() {
              this.dashboardView.render();
          },
          
          showRace: function(raceID) {
            if (raceID !== this.race.get('race_id')) {
              this.race.set('race_id', raceID);
              this.raceView.loading();
              this.race.fetch();
            }
            else {
              this.raceView.render();
            }
          },
          
          showRaceGroup: function(races) {
            this.races.options = this.races.options || {};
            races = races.split('/');
            
            this.races.options.field = (races.length == 1) ? 'office_name' : races.shift();
            this.races.options.search = races.shift();
            this.racesView.loading();
            this.races.fetch();
          }
        });
          
        // When ready, make the magic happen
        $(document).ready(function() {
          // Start application
          var workspace = new Workspace();
          Backbone.history.start();
        });
      })(jQueryCustom, window);
    </script>
  </div>
  <!-- END: Embeddable -->




</div>
</body>
</html>